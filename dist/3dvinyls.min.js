!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.vinyls=t(e)}(this,function(e){"use strict";var t,n,o,i,s,a,r,l,c,E,d,m,u,h,p,y={},T={},f=!!document.querySelector&&!!e.addEventListener,v=[],g=[],w="closed",M=!0,P={x:0,y:0},b={x:0,y:0},x={x:0,y:0},H=-1,R=-1,I=0,O={debug:!0,containerId:"vinyls",nbCrates:2,vinylsPerCrate:24,lightIntensity:1,cameraMouseMove:!0,backgroundColor:1118481,closeInfoPanelOnClick:!0,closeInfoPanelOnScroll:!0,callbackBefore:function(){},callbackAfter:function(){},constants:{vinylMoveTime:1e3,cameraMoveTime:800,infosOpenTime:800,vinylShownY:25,vinylFlippedY:100,cameraBasePosition:{x:270,y:180,z:110},cameraFocusPosition:{x:140,y:180,z:80},cameraMouseMoveSpeedY:.07,cameraMouseMoveSpeedZ:.03,grabSensitivity:6}},W=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.vinylXPos=-62+135/y.vinylsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(tt(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.vinylXPos,0,0),this.mesh.rotation.z=Math.PI/2,this.mesh.vinylId=e,this.mesh.visible=!1,this.absolutePosition=new THREE.Vector3,this.pushVinyl()};W.prototype.log=function(){console.log("Vinyl nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},W.prototype.showVinyl=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:y.constants.vinylShownY},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(s.position).to({x:this.vinylXPos,y:50+y.constants.vinylShownY,z:this.absolutePosition.z},y.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(i.position).to({x:this.vinylXPos+y.constants.cameraFocusPosition.x,y:y.constants.cameraFocusPosition.y,z:this.absolutePosition.z+y.constants.cameraFocusPosition.z},y.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},W.prototype.pushVinyl=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:0},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},W.prototype.pullVinyl=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:0},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},y.constants.vinylMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},W.prototype.flipVinyl=function(e){this.state="flipped",new TWEEN.Tween(this.mesh.position).to({y:y.constants.vinylFlippedY},y.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).delay(y.constants.infosOpenTime/4).to({y:Math.PI},y.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(s.position).to({x:this.vinylXPos,y:y.constants.vinylFlippedY+50,z:this.absolutePosition.z},y.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e)},W.prototype.flipBackVinyl=function(e){"flipped"===this.state&&(new TWEEN.Tween(this.mesh.position).delay(y.constants.infosOpenTime/2).to({y:0},y.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({y:0},y.constants.infosOpenTime/2).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(s.position).delay(y.constants.infosOpenTime/2).to({x:this.vinylXPos,y:75,z:this.absolutePosition.z},y.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start())};var N=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},z=function(){M&&(requestAnimationFrame(z),C(),y.debug&&n.update())},C=function(){TWEEN.update(),Y(),y.cameraMouseMove&&(x.x=.25*(P.x/m-.5),x.y=.25*(P.y/m-.5),E.rotation.y+=y.constants.cameraMouseMoveSpeedY*(x.x-E.rotation.y),E.rotation.z+=y.constants.cameraMouseMoveSpeedZ*(x.y-E.rotation.z)),i.lookAt(s.position),a.render(o,i)},L=function(){for(var e=0;e<g.length;e++)g[e].data=null,g[e].mesh.visible=!1;I=0},V=function(e){I>0&&L();for(var t=0;t<g.length&&t<e.length;t++)g[t].data=e[t],g[t].mesh.visible=!0,g[t].mesh.material.materials=tt(e[t].cover,e[t].hasSleeve);I=e.length<g.length?e.length:g.length,console.log("loadedVinyls",I)},S=function(e){"opened"===w?B():"opening"!==w&&"closing"!==w&&(H=e)},Q=function(){w="opening",g[H].flipVinyl(function(){w="opened"})},B=function(){"opened"===w&&(w="closing",g[H].flipBackVinyl(function(){w="closed"}))},Y=function(){if("closed"===w&&R!=H){R=H;for(var e=0;I>e;e++)-1==H?g[e].pushVinyl():e>H&&e>g[H].crateId*y.vinylsPerCrate&&e<g[H].crateId*y.vinylsPerCrate+y.vinylsPerCrate?g[e].pullVinyl():e==H?g[e].showVinyl():g[e].pushVinyl()}},j=function(){H=-1,new TWEEN.Tween(s.position).to({x:0,y:0,z:0},y.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(i.position).to({x:y.constants.cameraBasePosition.x,y:y.constants.cameraBasePosition.y,z:y.constants.cameraBasePosition.z},y.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()},k=function(){S(-1==H?I-1:I-1>H?H+1:0)},X=function(){S(-1==H?0:H>0?H-1:I-1)},F=function(e){var t=0,n=0,o=0,i=0,s=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),s.offsetParent)do o+=s.offsetLeft,i+=s.offsetTop;while(s=s.offsetParent);P.x=t-o,P.y=n-i},G=function(e){return"closed"===w?nt(e)<0?k():X():"opened"===w&&y.closeInfoPanelOnScroll&&B(),!1},D=function(e){if("closed"===w){var t=new THREE.Vector3((e.clientX-a.domElement.offsetLeft)/a.domElement.width*2-1,2*-((e.clientY-a.domElement.offsetTop)/a.domElement.height)+1,.5);r.unprojectVector(t,i);var n=new THREE.Raycaster(i.position,t.sub(i.position).normalize()),o=n.intersectObjects(d.children,!0);if(o.length>0&&o[0].object.vinylId>=0){var s=g[o[0].object.vinylId];H===s.id?Q():S(s.id)}else j();return!1}},A=function(){clearInterval(h),"closed"===w?(q(P.y),b={x:P.x,y:P.y}):"opened"===w&&y.closeInfoPanelOnClick&&B()},U=function(e){clearInterval(h),classie.remove(a.domElement,"grab"),ot(b,P,y.constants.grabSensitivity)&&D(e)},q=function(e){h=setTimeout(function(){classie.add(a.domElement,"grab");var t=(e-P.y)/u;t>0?X():0>t&&k(),q(e)},75)},Z=function(){o=new THREE.Scene,a=new THREE.WebGLRenderer({antialias:!0}),a.setSize(m,u),t.appendChild(a.domElement),a.domElement.id="context",a.setClearColorHex(y.backgroundColor,1),i=new THREE.PerspectiveCamera(45,m/u,.1,2e4),s=new THREE.Object3D,i.lookAt(s.position),r=new THREE.Projector,p=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("img/wood.jpg")}),E=new THREE.Object3D,d=new THREE.Object3D,o.add(E),E.add(d),K(),_(),l=new THREE.PointLight(16777215,1.1*y.lightIntensity),l.position.set(175,90,0),o.add(l),c=new THREE.PointLight(16777215,.6*y.lightIntensity),c.position.set(200,150,1e3),o.add(c),a.domElement.addEventListener("DOMMouseScroll",G,!1),a.domElement.addEventListener("mousewheel",G,!1),a.domElement.addEventListener("mousemove",F,!1),a.domElement.addEventListener("mousedown",A,!1),a.domElement.addEventListener("mouseup",U,!1),y.debug&&J(),j(),z()},J=function(){n=new Stats,n.domElement.style.position="absolute",n.domElement.style.left="0px",n.domElement.style.top="0px",t.style.position="relative",t.appendChild(n.domElement)},K=function(){for(var e=0;e<y.nbCrates;e++){var t=$(e);d.add(t)}d.position.z=-(110-110*y.nbCrates)/2},$=function(e){v[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),p);v[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),p);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,v[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),p);o.position.set(0,35,55),o.rotation.x=Math.PI/2,v[e].add(o)}var i=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),p);i.position.set(-105,35,0),i.rotation.z=Math.PI/2,v[e].add(i);var s=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),p);return s.position.set(95,25,0),s.rotation.z=Math.PI/2,v[e].add(s),v[e].position.z=-110*e,v[e]},_=function(){for(var e=0,t=0;t<v.length;t++)for(var n=0;n<y.vinylsPerCrate;n++)et(e,t,n),e++;console.log(g)},et=function(e,t,n){var o=new W(e,t,n);v[t].add(o.mesh),g.push(o)},tt=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e;var o=400,i=400,s=document.createElement("canvas");s.width=s.height=400;var a=new THREE.Texture(s);n.onload=function(){if(t){var e=new Image;e.src="img/sleeve.png",e.onload=function(){var t=s.getContext("2d");t.translate(o/2,i/2),t.rotate(Math.PI/2),t.translate(-o/2,-i/2),t.drawImage(n,130,130,135,135),t.drawImage(e,0,0,400,400),a.needsUpdate=!0}}else{var r=s.getContext("2d");r.translate(o/2,i/2),r.rotate(Math.PI/2),r.translate(-o/2,-i/2),r.drawImage(n,0,0,400,400),a.needsUpdate=!0}};var r=[new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:16777215,map:a}),new THREE.MeshLambertMaterial({color:1707525}),new THREE.MeshLambertMaterial({color:1707525})];return r},nt=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1},ot=function(e,t,n){return Math.abs(e.x-t.x)<=n&&Math.abs(e.y-t.y)<=n};return T.init=function(e){y=N(O,e),f&&Modernizr.webgl&&(console.log("initializing..."),console.log("options:",y),t=document.getElementById(y.containerId),m=y.canvasWidth?y.canvasWidth:t.offsetWidth,u=y.canvasHeight?y.canvasHeight:t.offsetHeight,console.log(t),Z())},T.selectVinyl=function(e){0>e?j():H=e>I?I-1:e},T.startRender=function(){M=!0,z()},T.stopRender=function(){M=!1},T.loadVinyls=V,T.unloadVinyls=L,T});
