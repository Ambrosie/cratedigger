!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.cratedigger=t(e)}(this,function(e){"use strict";var t,n,o,i,s,a,r,c,d,l,E,u,h,p,m,f,g,T,y,w={},v={},M=!!document.querySelector&&!!e.addEventListener,R=[],P=[],I="closed",x=!0,b={x:0,y:0},O={x:0,y:0},H={x:0,y:0},W=-1,N=-1,C=0,z={debug:!0,canvasWidth:null,canvasHeight:null,rootContainerId:"cratedigger",canvasContainerId:"cratedigger-canvas",loadingContainerId:"cratedigger-loading",infosContainerId:"cratedigger-infos",nbCrates:2,recordsPerCrate:24,lightIntensity:1,cameraMouseMove:!0,backgroundColor:1118481,sleeveColor:853762,closeInfoPanelOnClick:!0,closeInfoPanelOnScroll:!0,infoPanelOpacity:.8,callbackBefore:function(){},callbackAfter:function(){},constants:{recordMoveTime:1e3,cameraMoveTime:800,infosOpenTime:800,recordShownY:25,recordFlippedY:110,cameraBasePosition:{x:270,y:180,z:110},cameraFocusPosition:{x:140,y:180,z:80},cameraMouseMoveSpeedY:.07,cameraMouseMoveSpeedZ:.03,grabSensitivity:6}},B=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.recordXPos=-62+135/w.recordsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(st(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.recordXPos,0,0),this.mesh.rotation.z=Math.PI/2,this.mesh.recordId=e,this.mesh.visible=!1,this.absolutePosition=new THREE.Vector3,this.pushRecord()};B.prototype.log=function(){console.log("Record nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},B.prototype.showRecord=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:w.constants.recordShownY},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(c.position).to({x:this.recordXPos,y:50+w.constants.recordShownY,z:this.absolutePosition.z},w.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(r.position).to({x:this.recordXPos+w.constants.cameraFocusPosition.x,y:w.constants.cameraFocusPosition.y,z:this.absolutePosition.z+w.constants.cameraFocusPosition.z},w.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},B.prototype.pushRecord=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:0},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},B.prototype.pullRecord=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:0},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},w.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},B.prototype.flipRecord=function(e){this.state="flipped",new TWEEN.Tween(this.mesh.position).to({y:w.constants.recordFlippedY},w.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).delay(w.constants.infosOpenTime/4).to({y:Math.PI},w.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(c.position).to({x:this.recordXPos,y:w.constants.recordFlippedY+50,z:this.absolutePosition.z},w.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e)},B.prototype.flipBackRecord=function(e){"flipped"===this.state&&(new TWEEN.Tween(this.mesh.position).delay(w.constants.infosOpenTime/2).to({y:0},w.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({y:0},w.constants.infosOpenTime/2).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(c.position).delay(w.constants.infosOpenTime/2).to({x:this.recordXPos,y:75,z:this.absolutePosition.z},w.constants.infosOpenTime).easing(TWEEN.Easing.Quartic.Out).start())};var S=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},L=function(){x&&(requestAnimationFrame(L),j(),w.debug&&s.update())},j=function(){TWEEN.update(),G(),w.cameraMouseMove&&(H.x=.25*(b.x/f-.5),H.y=.25*(b.y/f-.5),p.rotation.y+=w.constants.cameraMouseMoveSpeedY*(H.x-p.rotation.y),p.rotation.z+=w.constants.cameraMouseMoveSpeedZ*(H.y-p.rotation.z)),r.lookAt(c.position),d.render(a,r)},Q=function(){for(var e=0;e<P.length;e++)P[e].data=null,P[e].mesh.visible=!1;C=0},k=function(e){C>0&&Q();for(var t=0;t<P.length&&t<e.length;t++)P[t].data=e[t],P[t].mesh.visible=!0,P[t].mesh.material.materials=st(e[t].cover,e[t].hasSleeve);C=e.length<P.length?e.length:P.length,console.log("loadedRecords",C)},Y=function(e){"opened"===I?X():"opening"!==I&&"closing"!==I&&(W=e)},F=function(){dt(i),I="opening",P[W].flipRecord(function(){I="opened"})},X=function(){"opened"===I&&(ct(i),I="closing",P[W].flipBackRecord(function(){I="closed"}))},G=function(){if("closed"===I&&N!=W){N=W;for(var e=0;C>e;e++)-1==W?P[e].pushRecord():e>W&&e>P[W].crateId*w.recordsPerCrate&&e<P[W].crateId*w.recordsPerCrate+w.recordsPerCrate?P[e].pullRecord():e==W?P[e].showRecord():P[e].pushRecord()}},A=function(){"opened"===I?X():"opening"!==I&&"closing"!==I&&(W=-1,new TWEEN.Tween(c.position).to({x:0,y:0,z:0},w.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(r.position).to({x:w.constants.cameraBasePosition.x,y:w.constants.cameraBasePosition.y,z:w.constants.cameraBasePosition.z},w.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},D=function(){-1==W?Y(C-1):C-1>W?Y(W+1):Y(0)},U=function(){-1==W?Y(0):W>0?Y(W-1):Y(C-1)},V=function(e){var t=0,n=0,o=0,i=0,s=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),s.offsetParent)do o+=s.offsetLeft,i+=s.offsetTop;while(s=s.offsetParent);b.x=t-o,b.y=n-i},q=function(e){return"closed"===I?at(e)<0?D():U():"opened"===I&&w.closeInfoPanelOnScroll&&X(),!1},Z=function(e){if("closed"===I){var t=new THREE.Vector3((e.x-d.domElement.offsetLeft)/d.domElement.width*2-1,2*-((e.y-d.domElement.offsetTop)/d.domElement.height)+1,.5);l.unprojectVector(t,r);var n=new THREE.Raycaster(r.position,t.sub(r.position).normalize()),o=n.intersectObjects(m.children,!0);if(o.length>0&&o[0].object.recordId>=0){var i=P[o[0].object.recordId];W===i.id?F():Y(i.id)}else A()}},J=function(){clearInterval(T),"closed"===I?($(b.y),O={x:b.x,y:b.y}):"opened"===I&&w.closeInfoPanelOnClick&&X()},K=function(){clearInterval(T),classie.remove(d.domElement,"grab"),rt(O,b,w.constants.grabSensitivity)&&Z(O)},$=function(e){T=setTimeout(function(){classie.add(d.domElement,"grab");var t=(e-b.y)/g;t>0?U():0>t&&D(),$(e)},75)},_=function(){a=new THREE.Scene,d=new THREE.WebGLRenderer({antialias:!0}),d.setSize(f,g),n.appendChild(d.domElement),d.domElement.id="context",d.setClearColor(w.backgroundColor,1),r=new THREE.PerspectiveCamera(45,f/g,.1,2e4),c=new THREE.Object3D,r.lookAt(c.position),l=new THREE.Projector;var e=THREE.ImageUtils.loadTexture("img/wood.jpg");e.anisotropy=d.getMaxAnisotropy(),y=new THREE.MeshLambertMaterial({map:e}),p=new THREE.Object3D,m=new THREE.Object3D,a.add(p),p.add(m),tt(),ot(),E=new THREE.PointLight(16777215,1.1*w.lightIntensity),E.position.set(300,80,0),a.add(E),u=new THREE.PointLight(16777215,.6*w.lightIntensity),u.position.set(-100,300,1e3),a.add(u),h=new THREE.PointLight(16777215,.6*w.lightIntensity),h.position.set(-100,300,-1e3),a.add(h),t.addEventListener("DOMMouseScroll",q,!1),t.addEventListener("mousewheel",q,!1),t.addEventListener("mousemove",V,!1),t.addEventListener("mousedown",J,!1),t.addEventListener("mouseup",K,!1),t.style.position="relative",n.style.position="absolute",i.style.position="absolute",o.style.position="absolute",console.log(g),t.style.height=g+"px",n.style.height=g+"px",i.style.height=g+"px",o.style.height=g+"px",t.style.width=f+"px",n.style.width=f+"px",i.style.width=f+"px",o.style.width=f+"px",i.style.display="none",ct(o),w.debug&&et(),A(),L()},et=function(){s=new Stats,s.domElement.style.position="absolute",s.domElement.style.left="0",s.domElement.style.top="0",t.appendChild(s.domElement);var e=new THREE.Mesh(new THREE.BoxGeometry(20,20,20,1,1,1));e.position.set(E.position.x,E.position.y,E.position.z),a.add(e)},tt=function(){for(var e=0;e<w.nbCrates;e++){var t=nt(e);m.add(t)}m.position.z=-(110-110*w.nbCrates)/2},nt=function(e){R[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),y);R[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),y);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,R[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),y);o.position.set(0,35,55),o.rotation.x=Math.PI/2,R[e].add(o)}var i=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),y);i.position.set(-105,35,0),i.rotation.z=Math.PI/2,R[e].add(i);var s=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),y);return s.position.set(95,25,0),s.rotation.z=Math.PI/2,R[e].add(s),R[e].position.z=-110*e,R[e]},ot=function(){for(var e=0,t=0;t<R.length;t++)for(var n=0;n<w.recordsPerCrate;n++)it(e,t,n),e++;console.log(P)},it=function(e,t,n){var o=new B(e,t,n);R[t].add(o.mesh),P.push(o)},st=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e?e:"";var o=400,i=400,s=document.createElement("canvas");s.width=s.height=400;var a=new THREE.Texture(s);n.onload=function(){if(t){var e=new Image;e.src="img/sleeve.png",e.onload=function(){var t=s.getContext("2d");t.translate(o/2,i/2),t.rotate(Math.PI/2),t.translate(-o/2,-i/2),t.drawImage(n,130,130,135,135),t.drawImage(e,0,0,400,400),a.needsUpdate=!0}}else{var r=s.getContext("2d");r.translate(o/2,i/2),r.rotate(Math.PI/2),r.translate(-o/2,-i/2),r.drawImage(n,0,0,400,400),a.needsUpdate=!0}};var r=new THREE.MeshLambertMaterial({color:w.sleeveColor}),c=[r,r,r,new THREE.MeshLambertMaterial({color:16777215,map:a}),r,r];return c},at=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1},rt=function(e,t,n){return Math.abs(e.x-t.x)<=n&&Math.abs(e.y-t.y)<=n},ct=function(e){e.style.opacity<=0?(e.style.display="none",e.style.opacity=0):(e.style.opacity-=.1,setTimeout(function(){ct(e)},10))},dt=function(e,t){e.style.opacity<w.infoPanelOpacity?("none"==e.style.display&&(e.style.display="block",t=0),t+=.03,e.style.opacity=t,setTimeout(function(){dt(e,t)},10)):e.style.opacity=w.infoPanelOpacity};return v.init=function(e){if(w=S(z,e),M&&Modernizr.webgl){if(console.log("initializing..."),console.log("options:",w),t=document.getElementById(w.rootContainerId),!t)return console.log("cratedigger.js - Init failed : can not find root container element."),void 0;if(n=document.getElementById(w.canvasContainerId),!t)return console.log("cratedigger.js - Init failed : can not find canvas container element."),void 0;if(o=document.getElementById(w.loadingContainerId),!t)return console.log("cratedigger.js - Init failed : can not find loading container element."),void 0;if(i=document.getElementById(w.infosContainerId),!t)return console.log("cratedigger.js - Init failed : can not find infos container element."),void 0;f=w.canvasWidth?w.canvasWidth:t.offsetWidth,g=w.canvasHeight?w.canvasHeight:t.offsetHeight,_()}},v.selectRecord=function(e){0>e?A():W=e>C?C-1:e},v.startRender=function(){x=!0,L()},v.stopRender=function(){x=!1},v.loadRecords=k,v.unloadRecords=Q,v.resetShownRecord=A,v.canvas=function(){return d.domElement},v});